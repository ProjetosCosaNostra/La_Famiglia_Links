<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š RelatÃ³rios â€” La Famiglia Links</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="dashboard">
    <header>
      <h1>ğŸ“Š RelatÃ³rios Financeiros da FamÃ­lia</h1>
      <p>â€œNada Ã© coincidÃªncia... Ã© estratÃ©gia.â€</p>
      <a href="/business/view" class="btn-voltar">â¬… Voltar</a>
    </header>

    <section class="resumo">
      <div class="card">
        <h2>ğŸ’° Total Recebido</h2>
        <p>R$ {{ "%.2f"|format(total_valor) }}</p>
      </div>
      <div class="card">
        <h2>ğŸ‘¥ Clientes</h2>
        <p>{{ total_clientes }}</p>
      </div>
      <div class="card">
        <h2>ğŸ§¾ TransaÃ§Ãµes</h2>
        <p>{{ total_transacoes }}</p>
      </div>
    </section>

    <section class="graficos">
      <canvas id="graficoReceita" height="120"></canvas>
    </section>

    <section class="historico">
      <h2>ğŸ“œ Ãšltimos Pagamentos</h2>
      <table>
        <tr><th>Email</th><th>Plano</th><th>Valor</th><th>Moeda</th><th>Data</th></tr>
        {% for email, plan, amount, currency, created_at in ultimos %}
        <tr>
          <td>{{ email or "-" }}</td>
          <td>{{ plan or "-" }}</td>
          <td>R$ {{ "%.2f"|format((amount or 0) / 100) }}</td>
          <td>{{ currency.upper() }}</td>
          <td>{{ created_at }}</td>
        </tr>
        {% endfor %}
      </table>
    </section>

    <section class="afiliados">
      <h2>ğŸ† Top Afiliados</h2>
      <ul>
        {% for email, qtd, valor in afiliados_top %}
        <li>{{ email }} â€” {{ qtd }} vendas â€” R$ {{ "%.2f"|format((valor or 0)/100) }}</li>
        {% endfor %}
      </ul>
    </section>

    <footer>
      <p>Â© 2025 â€” Cosa Nostra Systems</p>
    </footer>
  </div>

  <script>
    // Gera grÃ¡fico com dados da API
    fetch('/business/reports/api')
      .then(r => r.json())
      .then(dados => {
        const ctx = document.getElementById('graficoReceita');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: dados.map(e => e.data),
            datasets: [{
              label: 'Receita DiÃ¡ria (R$)',
              data: dados.map(e => e.total),
              borderColor: '#d4af37',
              backgroundColor: 'rgba(212,175,55,0.2)',
              tension: 0.4
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } },
              x: { grid: { color: 'rgba(255,255,255,0.1)' } }
            },
            plugins: { legend: { labels: { color: '#d4af37' } } }
          }
        });
      });
  </script>
</body>
</html>
